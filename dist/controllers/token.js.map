{"version":3,"sources":["controllers/token.js"],"names":[],"mappings":"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","file":"controllers/token.js","sourcesContent":["/**\n * Created by Bell on 16/8/24.\n */\n\nimport * as token_util from '../utils/token';\nimport * as response_util from '../utils/response';\nimport * as token_redis from '../redis/token';\nimport * as user_redis from '../redis/user';\nimport Token from '../models/token';\nimport * as auth from '../tools/auth';\nimport * as check from '../tools/check';\nimport Debug from 'debug';\nimport pkg from '../../package.json';\nconst debug = new Debug(pkg.name);\n\n/**\n * generate new token\n *\n * @param ctx\n * @param next\n * @returns {*}\n */\nexport async function generate(ctx, next) {\n    debug(ctx.request.body);\n    const name = ctx.request.body.name;\n    if (!check.checkEmpty(ctx, 'Token', 'name', name)) {\n        return;\n    }\n\n    const password = ctx.request.body.password;\n    if (!check.checkEmpty(ctx, 'User', 'password', password)) {\n        return;\n    }\n\n    let user = null;\n    try {\n        user = await auth.getFullUser(ctx);\n    } catch (err) {\n        ctx.throw(500);\n    }\n\n    if (!user) {\n        ctx.throw(401);\n    }\n\n    // validate password\n    let result = false;\n    try {\n        result = await user.validatePassword(password);\n    } catch (err) {\n        ctx.throw(500);\n    }\n    if (!result) {\n        response_util.fieldInvalid(ctx, 'User', 'password', 'Invalid password');\n        return;\n    }\n\n    const payload = token_util.generateCheckPatchPayload(user.id);\n    const token = token_util.generateTokenFromPayload(payload);\n    if (!token) {\n        ctx.throw(500);\n    }\n\n    const token_object = new Token({userid: user.id, token, name, type: 1});\n    try {\n        await token_object.save();\n        await token_redis.add(token, payload.exp);\n    } catch (err) {\n        ctx.throw(500, err.message);\n    }\n\n    // response\n    const response = token_object.toJSON();\n    ctx.body = response;\n    ctx.statusCode = 201;\n}\n\n/**\n * generate new token\n *\n * @param ctx\n * @param next\n * @returns {*}\n */\nexport async function list(ctx, next) {\n    const type = ctx.request.body.type || 1;\n    const userid = auth.getID(ctx);\n    if (!userid) {\n        ctx.throw(401);\n    }\n    let token_objects = await Token.find({userid, type}).lean();\n    let array = [];\n    for (let token_object of token_objects) {\n        const payload = token_util.getPayload(token_object.token);\n        if (payload) {\n            const timestamp = await user_redis.getTimestamp(payload.id);\n            // whether token is valid\n            if (!timestamp || timestamp == 0 || payload.iat > timestamp) {\n                delete token_object.token;\n                array.push(token_object);\n            }\n        }\n    }\n    ctx.body = array || [];\n}\n\n/**\n * get token detail\n *\n * @example curl -H \"Content-Type: application/json\" -X POST localhost:4002/tokens/:id\n * @param ctx\n * @param next\n * @returns {*}\n */\nexport async function detail(ctx, next) {\n    const id = ctx.params.id;\n    const password = ctx.request.body.password;\n\n    if (!check.checkPatchEmpty(ctx, 'password', password)) {\n        return;\n    }\n\n    const user = await auth.getFullUser(ctx);\n    if (!user) {\n        ctx.throw(401);\n    }\n\n    const result = await user.validatePassword(password);\n    if (!result) {\n        response_util.fieldInvalid(ctx, 'User', 'password', 'Invalid password');\n        return;\n    }\n\n    let token = null;\n    try {\n        token = await Token.findById(id);\n    } catch (err) {\n        ctx.throw(500);\n    }\n    if (!token) {\n        response_util.resourceNotExist(ctx, 'Token', 'id');\n        return;\n    }\n    if (token.userid != user.id) {\n        ctx.throw(403);\n    }\n\n    // response\n    const response = token.toJSON();\n    ctx.body = response;\n}\n\n/**\n * delete token\n *\n * @param ctx\n * @param next\n * @returns {*}\n */\nexport async function del(ctx, next) {\n    const id = ctx.params.id;\n    if (!id) {\n        ctx.throw(400, 'id can not be empty');\n    }\n    const userid = auth.getID(ctx);\n    if (!userid) {\n        ctx.throw(403);\n    }\n    try {\n        await Token.remove({_id:id, userid});\n    } catch (err) {\n        ctx.throw(422, 'unvalid id');\n    }\n    ctx.status = 204;\n}\n"],"sourceRoot":"/source/"}