{"version":3,"sources":["controllers/token.js"],"names":[],"mappings":"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","file":"controllers/token.js","sourcesContent":["/**\n * Created by Bell on 16/8/24.\n */\n\nimport * as token_util from '../utils/token';\nimport * as token_redis from '../redis/token';\nimport * as user_redis from '../redis/user';\nimport Token from '../models/token';\nimport * as auth from '../tools/auth';\nimport Debug from 'debug';\nimport pkg from '../../package.json';\nconst debug = new Debug(pkg.name);\n\n/**\n * generate new token\n *\n * @param ctx\n * @param next\n * @returns {*}\n */\nexport async function generate(ctx, next) {\n    debug(ctx.request.body);\n    const name = ctx.request.body.name;\n\n    if (!name) {\n        ctx.throw(400, 'name can not be empty');\n    }\n\n    const userid = auth.getID(ctx);\n    if (!userid) {\n        ctx.throw(401);\n    }\n\n    const payload = token_util.generateCheckPatchPayload(userid);\n    const token = token_util.generateTokenFromPayload(payload);\n    if (!token) {\n        ctx.throw(500);\n    }\n\n    const token_object = new Token({userid, token, name, type: 1});\n    try {\n        await token_object.save();\n        await token_redis.add(token, payload.exp);\n    } catch (err) {\n        ctx.throw(500, err.message);\n    }\n\n    // response\n    const response = token_object.toJSON();\n    ctx.body = response;\n}\n\n/**\n * generate new token\n *\n * @param ctx\n * @param next\n * @returns {*}\n */\nexport async function list(ctx, next) {\n    const type = ctx.request.body.type || 1;\n    const userid = auth.getID(ctx);\n    if (!userid) {\n        ctx.throw(403);\n    }\n    let tokens = await Token.find({userid, type}).lean();\n    let array = [];\n    for (let token of tokens) {\n        const payload = token_util.getPayload(token);\n        if (payload) {\n            const timestamp = await user_redis.getTimestamp(payload.id);\n            // whether token is valid\n            if (!timestamp || timestamp == 0 || payload.iat > timestamp) {\n                delete token.token;\n                array.push(token);\n            }\n        }\n    }\n    ctx.body = array || [];\n}\n\n/**\n * get token detail\n *\n * @example curl -H \"Content-Type: application/json\" -X POST localhost:4002/tokens/:id\n * @param ctx\n * @param next\n * @returns {*}\n */\nexport async function detail(ctx, next) {\n    const id = ctx.params.id;\n    if (!id) {\n        ctx.throw(400, 'id can not be empty');\n    }\n    const password = ctx.request.body.password;\n    if (!password) {\n        ctx.throw(400, 'password can not be empty');\n    }\n\n    const user = await auth.getFullUser(ctx);\n    if (!user) {\n        ctx.throw(403, 'unvalid token');\n    }\n\n    const result = await user.validatePassword(password);\n    if (!result) {\n        ctx.throw(403, 'error password');\n    }\n\n    let token = null;\n    try {\n        token = await Token.findById(id);\n    } catch (err) {\n        ctx.throw(422, 'unvalid id');\n    }\n    if (!token) {\n        ctx.throw(422, 'unvalid id');\n    }\n    if (token.userid != user.id) {\n        ctx.throw(403, 'no permission');\n    }\n\n    // response\n    const response = token.toJSON();\n    ctx.body = response;\n}\n\n/**\n * delete token\n *\n * @param ctx\n * @param next\n * @returns {*}\n */\nexport async function del(ctx, next) {\n    const id = ctx.params.id;\n    if (!id) {\n        ctx.throw(400, 'id can not be empty');\n    }\n    const userid = auth.getID(ctx);\n    if (!userid) {\n        ctx.throw(403);\n    }\n    try {\n        await Token.remove({_id:id, userid});\n    } catch (err) {\n        ctx.throw(422, 'unvalid id');\n    }\n    ctx.status = 204;\n}\n"],"sourceRoot":"/source/"}