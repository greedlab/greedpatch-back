{"version":3,"sources":["controllers/user.js"],"names":[],"mappings":"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","file":"controllers/user.js","sourcesContent":["/**\n * Created by Bell on 16/8/10.\n */\n\nimport passport from 'koa-passport';\nimport User from '../models/user';\nimport Token from '../models/token';\n// import UnvalidToken from '../models/unvalid-token';\nimport {addToken as addUnvalidToken} from '../utils/unvalid-token';\nimport * as regex from '../utils/regex';\nimport * as auth from '../utils/auth';\nimport * as token_util from '../utils/token';\nimport Debug from 'debug';\nimport pkg from '../../package.json';\nconst debug = new Debug(pkg.name);\n\n/**\n * list users\n *\n * @example curl -H \"Authorization: Bearer <token>\" -X POST localhost:4002/user/list\n *\n * @param ctx\n * @param next\n * @returns {*}\n */\nexport async function list(ctx, next) {\n    try {\n        const users = await User.find({},{password: 0, __v: 0});\n        if (!users) {\n            ctx.throw(404);\n        }\n        ctx.body = {\n            users\n        };\n    } catch (err) {\n        if (err === 404 || err.name === 'CastError') {\n            ctx.throw(404);\n        }\n        ctx.throw(500);\n    }\n\n    if (next) {\n        return next();\n    }\n}\n\n/**\n * register\n *\n * @example curl -H \"Content-Type: application/json\" -X POST -d '{ \"email\": \"greedpatch@greedlab.com\", \"password\": \"secretpasas\" }' localhost:4002/register\n * @param ctx\n * @param next\n * @returns {*}\n */\nexport async function register(ctx, next) {\n    debug(ctx.request.body);\n    if (!regex.validEmail(ctx.request.body.email)) {\n        ctx.throw(400, 'invalid email');\n    }\n    if (!regex.validPassword(ctx.request.body.password)) {\n        ctx.throw(400, 'invalid password');\n    }\n    const user = new User(ctx.request.body);\n    try {\n        await user.save();\n    } catch (err) {\n        ctx.throw(422, 'email is existed');\n    }\n    const token = user.generateToken();\n    await token_util.saveToken(token);\n\n    // response\n    const response = user.toJSON();\n    delete response.password;\n    ctx.body = {\n        token,\n        user: response\n    };\n    if (next) {\n        return next();\n    }\n}\n\n/**\n * login\n *\n * @example curl -H \"Content-Type: application/json\" -X POST -d '{ \"email\": \"greedpatch@greedlab.com\", \"password\": \"secretpasas\" }' localhost:4002/login\n * @param ctx\n * @param next\n * @returns {*}\n */\nexport async function login(ctx, next) {\n    let options = {\n        session: false\n    };\n    return passport.authenticate('local', options, async (user) => {\n        if (!user) {\n            ctx.throw('unvalid email or password', 401);\n        }\n        const token = user.generateToken();\n        await token_util.saveToken(token);\n\n        const response = user.toJSON();\n        delete response.password;\n        ctx.body = {\n            token,\n            user: response\n        };\n    })(ctx, next);\n}\n\n/**\n * logout\n *\n * @example curl -H \"Authorization: Bearer <token>\" -X POST localhost:4002/logout\n * @param ctx\n * @param next\n * @returns {*}\n */\nexport async function logout(ctx, next) {\n    try {\n        const token = auth.getToken(ctx);\n        if (token) {\n            addUnvalidToken(token);\n        }\n    } catch (err) {\n        ctx.throw(422, err.message);\n    }\n    ctx.status = 204;\n}\n\n/**\n * modify my password\n *\n * @example curl -H \"Authorization: Bearer <token>\" -X POST -d '{\"password\": \"password\", \"new_password\": \"new_password\"}' localhost:4002/modify-my-password\n * @param ctx\n * @param next\n */\nexport async function modifyMyPassword(ctx, next) {\n    debug(ctx.request.body);\n    const user = auth.getUser(ctx);\n    if (!user) {\n        ctx.throw(401);\n    }\n    const password = ctx.request.body.password;\n    const newPassword = ctx.request.body.new_password;\n    if (!password || !newPassword) {\n        ctx.throw(400);\n    }\n    const equal = await auth.compareHashString(password, user.password);\n    if (!equal) {\n        ctx.throw(401);\n    }\n    const hashedNewPassword = await auth.hashString(newPassword);\n    try {\n        await user.update({password: hashedNewPassword});\n    } catch (err) {\n        ctx.throw(422, 'unvalid new_password');\n    }\n    // set origin token unvalid\n    addUnvalidToken(auth.getToken(ctx));\n\n    const token = user.generateToken();\n    await token_util.saveToken(token);\n\n    const response = user.toJSON();\n    ctx.body = {\n        token,\n        user: response\n    };\n    if (next) {\n        return next();\n    }\n}\n\n/**\n * get my profile\n *\n * @example curl -H \"Authorization: Bearer <token>\" -X GET localhost:4002/users/my/profile\n * @param ctx\n * @param next\n */\nexport async function myProfile(ctx, next) {\n    debug(ctx.request.body);\n    const user = auth.getUser(ctx);\n    if (!user) {\n        ctx.throw(401);\n    }\n    const response = user.toJSON();\n    ctx.body = response;\n    if (next) {\n        return next();\n    }\n}\n\n/**\n * reset my password\n *\n * @example curl -X POST -d '{\"email\": \"greedpatch@greedlab.com\"}' localhost:4002/reset-my-password\n * @param ctx\n * @param next\n */\nexport async function resetPassword(ctx, next) {\n    debug(ctx.request.body);\n    const user = auth.getUser(ctx);\n    if (!user) {\n        ctx.throw(401);\n    }\n    const password = ctx.request.body.password;\n    if (!password) {\n        ctx.throw(400);\n    }\n    const hashedPassword = await auth.hashString(password);\n    try {\n        await user.update({password: hashedPassword});\n    } catch (err) {\n        ctx.throw(422, 'unvalid password');\n    }\n    // set origin token unvalid\n    addUnvalidToken(auth.getToken(ctx));\n\n    const token = user.generateSetPasswordToken();\n\n    // save token\n    const tokenObject = new Token({token, type: 2});\n    await tokenObject.save();\n\n    const response = user.toJSON();\n    ctx.body = {\n        token,\n        user: response\n    };\n    if (next) {\n        return next();\n    }\n}\n\n/**\n * set my password\n *\n * @example curl -H \"Authorization: Bearer <token>\" -X POST -d '{password: \"password\"}' localhost:4002/set-my-password\n * @param ctx\n * @param next\n */\nexport async function setMyPassword(ctx, next) {\n    debug(ctx.request.body);\n    const email = ctx.request.body.email;\n    if (!email) {\n        ctx.throw(400, 'email is empty');\n    }\n    if (!regex.validEmail(email)) {\n        ctx.throw(400, 'unvalid email');\n    }\n    let user = null;\n    try {\n        user = await User.find({email: email},{password: 0, __v: 0});\n    } catch (err) {\n        ctx.throw(422, 'unvalid email');\n    }\n    if (!user) {\n        ctx.throw(422, 'user is not existed');\n    }\n    // TODO send <front >/set-password?token=<token> to email\n    const token = user.generateToken();\n    await token_util.saveToken(token);\n\n    ctx.body = {\n        message : 'please set password through your email'\n    };\n    if (next) {\n        return next();\n    }\n}\n\n/**\n * udpate user's password\n *\n * @example curl -H \"Authorization: Bearer <token>\" -X POST -d '{password: \"password\"}' localhost:4002/users/:id/password\n * @param ctx\n * @param next\n */\nexport async function updatePassword(ctx, next) {\n    debug(ctx.request.body);\n    const userid = ctx.params.id;\n    const password = ctx.request.body.password;\n    if (!userid) {\n        ctx.throw(400, 'id is empty');\n    }\n    if (!password) {\n        ctx.throw(400, 'password is empty');\n    }\n    if (!regex.validPassword(password)) {\n        ctx.throw(400, 'unvalid password');\n    }\n    let user = null;\n    try {\n        user = await User.findById(userid, {password: 0, __v: 0});\n    } catch (err) {\n        ctx.throw(422, 'unvalid id');\n    }\n    if (!user) {\n        ctx.throw(422, 'user is not existed');\n    }\n\n    const docs = await Token.find({userid, status: 0});\n    for (let doc of docs) {\n        if (doc.token) {\n            await addUnvalidToken(doc.token);\n            await doc.update({status: 1});\n        }\n    }\n    const token = user.generateToken();\n    await token_util.saveToken(token);\n    ctx.status = 204;\n    if (next) {\n        return next();\n    }\n}\n\n/**\n * update user status\n *\n * @example curl -H \"Authorization: Bearer <token>\" -X POST -d '{password: \"password\"}' localhost:4002/users/:id/status\n * @param ctx\n * @param next\n * @returns {*}\n */\nexport async function updateStatus(ctx, next) {\n    debug(ctx.request.body);\n    const userid = ctx.params.id;\n    const status = ctx.request.body.status;\n    if (!userid) {\n        ctx.throw(400, 'id is empty');\n    }\n    if (!status) {\n        ctx.throw(400, 'status is empty');\n    }\n    if (status < 0 || status > 1) {\n        ctx.throw(400, 'unvalid status');\n    }\n    let user = null;\n    try {\n        user = await User.findById(userid, {password: 0, __v: 0});\n    } catch (err) {\n        ctx.throw(422, 'unvalid id');\n    }\n    if (!user) {\n        ctx.throw(422, 'user is not existed');\n    }\n    try {\n        await user.update({status: status});\n    } catch (err) {\n        ctx.throw(422, 'unvalid status');\n    }\n    ctx.status = 204;\n    if (next) {\n        return next();\n    }\n}\n"],"sourceRoot":"/source/"}